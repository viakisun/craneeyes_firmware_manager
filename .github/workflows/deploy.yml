name: CD - Deploy to EC2

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'home/**'
      - 'scripts/**'
      - 'server.js'
      - 'sftp-server.js'
      - 'package.json'
      - 'package-lock.json'
      - 'database/**'
      - 'ecosystem.config.cjs'
      - 'nginx.conf'
      - '.github/workflows/deploy.yml'

  workflow_dispatch:
    inputs:
      reason:
        description: 'Deployment reason'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ—ï¸ Build frontend
        run: npm run build
        env:
          # Only frontend-safe variables (no AWS credentials!)
          VITE_API_BASE_URL: https://firmware.craneeyes.com/api
      
      - name: ğŸ“¦ Create deployment package
        run: |
          tar -czf deployment.tar.gz \
            dist/ \
            home/ \
            src/ \
            server.js \
            sftp-server.js \
            package.json \
            package-lock.json \
            ecosystem.config.cjs \
            nginx.conf \
            database/ \
            scripts/
      
      - name: ğŸ”‘ Setup SSH key
        run: |
          mkdir -p ~/.ssh
          
          # Decode base64 SSH key
          echo "${{ secrets.EC2_SSH_KEY_BASE64 }}" | base64 -d > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          
          # Add EC2 host to known_hosts
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          
          # Verify SSH key format
          echo "ğŸ” Verifying SSH key..."
          if ssh-keygen -l -f ~/.ssh/deploy_key >/dev/null 2>&1; then
            echo "âœ… SSH key format is valid"
            echo "Key fingerprint:"
            ssh-keygen -l -f ~/.ssh/deploy_key
            echo "Key type:"
            ssh-keygen -l -f ~/.ssh/deploy_key | awk '{print $NF}'
            echo "Expected: SHA256:iPlXZTu7Lq0RcrrdyhTO2jWip1O8n/TZiIMkZjH4Gq8"
          else
            echo "âŒ SSH key format is invalid"
            echo "Please check the EC2_SSH_KEY_BASE64 secret in GitHub settings"
            exit 1
          fi
          
          # Test if key file is readable
          echo "ğŸ” Key file permissions:"
          ls -la ~/.ssh/deploy_key
          
          # Verify we're connecting to correct host
          echo "ğŸ” Target host: ${{ secrets.EC2_HOST }}"
          echo "ğŸ” Target user: ${{ secrets.EC2_USER }}"
      
      - name: ğŸ”Œ Test SSH connection
        run: |
          ssh -i ~/.ssh/deploy_key \
            -vvv \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -o ConnectTimeout=10 \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "echo 'âœ… SSH connection successful'"
      
      - name: ğŸ“¤ Upload deployment package
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            deployment.tar.gz \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/tmp/
      
      - name: ğŸš€ Deploy on EC2
        run: |
          ssh -i ~/.ssh/deploy_key \
            -vvv \
            -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'ENDSSH'
            set -e
            
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "ğŸš€ Starting deployment..."
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            
            # Kill any processes using required ports
            echo "ğŸ” Checking for processes on ports 3001 and 2222..."
            for port in 3001 2222; do
              PID=$(lsof -t -i:$port 2>/dev/null || true)
              if [ ! -z "$PID" ]; then
                echo "âš ï¸  Killing process $PID on port $port"
                kill -9 $PID 2>/dev/null || true
                sleep 1
              fi
            done
            
            # Navigate to project directory (create if doesn't exist)
            PROJECT_DIR="/home/ec2-user/craneeyes-firmware-manager"
            if [ ! -d "$PROJECT_DIR" ]; then
              echo "ğŸ“ First deployment - creating project directory..."
              mkdir -p "$PROJECT_DIR"
            fi
            cd "$PROJECT_DIR"
            
            # Backup current version (if exists)
            if [ -d "dist" ]; then
              echo "ğŸ“¦ Creating backup..."
              tar -czf backup-$(date +%Y%m%d-%H%M%S).tar.gz dist/ || true
            fi
            
            # Extract new files
            echo "ğŸ“¥ Extracting deployment package..."
            tar -xzf /tmp/deployment.tar.gz
            rm /tmp/deployment.tar.gz
            
            # Install/update dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install --production
            
            # Create/update environment file
            echo "ğŸ“ Creating .env file from secrets..."
            cat > .env << EOF
          # Backend-only AWS credentials (NEVER expose to frontend)
          AWS_REGION=${{ secrets.AWS_REGION }}
          AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_BUCKET_NAME=${{ secrets.AWS_BUCKET_NAME }}
          
          # Backend-only DB credentials (NEVER expose to frontend)
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_NAME=${{ secrets.DB_NAME }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # Legacy vars (for backward compatibility with old code)
          VITE_AWS_REGION=${{ secrets.AWS_REGION }}
          VITE_AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          VITE_AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          VITE_AWS_BUCKET_NAME=${{ secrets.AWS_BUCKET_NAME }}
          VITE_AWS_DB_HOST=${{ secrets.DB_HOST }}
          VITE_AWS_DB_PORT=${{ secrets.DB_PORT }}
          VITE_AWS_DB_NAME=${{ secrets.DB_NAME }}
          VITE_AWS_DB_USER=${{ secrets.DB_USER }}
          VITE_AWS_DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          
          # API & SFTP Configuration
          VITE_API_BASE_URL=https://firmware.craneeyes.com/api
          API_PORT=${{ secrets.API_PORT }}
          SFTP_PORT=${{ secrets.SFTP_PORT }}
          EOF
            echo "âœ… .env file created"
            
            # Run database migrations
            echo "ğŸ’¾ Running database migrations..."
            export PGPASSWORD="${{ secrets.DB_PASSWORD }}"
            psql -h ${{ secrets.DB_HOST }} -p ${{ secrets.DB_PORT }} -U ${{ secrets.DB_USER }} -d ${{ secrets.DB_NAME }} -f database/add-allowed-models.sql || echo "Migration may have already been applied"
            echo "âœ… Database migrations completed"
            
            # Copy frontend files to Nginx directory
            echo "ğŸ“‹ Copying frontend files..."
            sudo mkdir -p /var/www/html/craneeyes
            sudo cp -r dist/* /var/www/html/craneeyes/
            sudo chown -R nginx:nginx /var/www/html/craneeyes || sudo chown -R www-data:www-data /var/www/html/craneeyes
            
            # Copy landing page to Nginx directory
            echo "ğŸ“‹ Copying landing page..."
            sudo mkdir -p /var/www/html/craneeyes-landing
            sudo cp -r home/* /var/www/html/craneeyes-landing/
            sudo chown -R nginx:nginx /var/www/html/craneeyes-landing || sudo chown -R www-data:www-data /var/www/html/craneeyes-landing
            
            # Deploy Nginx configuration
            echo "ğŸ”§ Deploying Nginx configuration..."
            sudo cp nginx.conf /etc/nginx/conf.d/craneeyes.conf
            
            # Test Nginx configuration
            echo "ğŸ§ª Testing Nginx configuration..."
            sudo nginx -t
            
            # Reload Nginx
            echo "ğŸ”„ Reloading Nginx..."
            sudo systemctl reload nginx || sudo systemctl restart nginx
            
            echo "âœ… Nginx configuration deployed and reloaded"
            
            # Restart backend services with PM2
            echo "ğŸ”„ Restarting services..."
            if pm2 list | grep -q "craneeyes"; then
              pm2 restart ecosystem.config.cjs --update-env
            else
              pm2 start ecosystem.config.cjs
            fi
            
            # Save PM2 configuration
            pm2 save
            
            # Reload Nginx
            echo "ğŸ”„ Reloading Nginx..."
            if sudo nginx -t 2>/dev/null; then
              sudo systemctl reload nginx
            else
              echo "âš ï¸  Nginx configuration test failed, skipping reload"
            fi
            
            echo ""
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo "âœ… Deployment completed successfully!"
            echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
            echo ""
            
            # Show service status
            echo "ğŸ“Š Service Status:"
            pm2 list
          ENDSSH
      
      - name: ğŸ¥ Health check
        run: |
          echo "â³ Waiting for services to start..."
          sleep 10
          
          echo "ğŸ¥ Checking API health..."
          for i in {1..5}; do
            if curl -f https://firmware.craneeyes.com/api/health 2>/dev/null || curl -f http://firmware.craneeyes.com/api/health 2>/dev/null; then
              echo "âœ… API is healthy!"
              exit 0
            fi
            echo "â³ Attempt $i/5 failed, retrying in 5 seconds..."
            sleep 5
          done
          
          echo "âš ï¸  Health check failed, but deployment completed. Please check manually."
          exit 0
      
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
          rm -f deployment.tar.gz
      
      - name: ğŸ“¢ Deployment summary
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“Š Deployment Summary"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ  Landing: https://craneeyes.com"
          echo "ğŸŒ Firmware Manager: https://firmware.craneeyes.com"
          echo "ğŸ”Œ API: https://firmware.craneeyes.com/api"
          echo "ğŸ“ SFTP: sftp -P ${{ secrets.SFTP_PORT }} user@firmware.craneeyes.com"
          echo "â° Deployed at: $(date)"
          echo "âœ… Status: Success"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

